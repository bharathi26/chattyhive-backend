<!DOCTYPE html>
<html>
<head>
    <title>CHAT</title>
    <script src="http://js.pusher.com/2.1/pusher.min.js" type="text/javascript"></script>
    <script src="../../static/js/jquery-2.0.3.min.js" type="text/javascript"></script>
</head>
<body>
    Welcome, {{ user }}!
    <button type="button" id="btn_logout" onclick="onLogout()" style="text-align: right">Logout</button>
    <p id="chat_field"></p>
    <input id="msg_text" type="text">
    <button type="button" id="btn_send" onclick="onClick()">Send</button>

    <script type="text/javascript">

        var num_rep=0;
        var user="{{ user }}";
        var app_key="{{ app_key }}";
        var key="{{ key }}";
        var channel_name="{{ channel }}";
        var event_name="{{ event }}";
        var chat="{{ chat_field }}";

        // Connecting to pusher
        var pusher = new Pusher(key);
        var channel = pusher.subscribe(channel_name);

        // Listening to the channel
        channel.bind(event_name, function(data) {
            if(data.user!=user) write(data.user,data.msg);
        });

        // Button Send behaviour
        function onClick() {
            var text_sent = $("#msg_text").val();
            $("#msg_text").val("");
            write(user, text_sent);
            loadXMLDoc(text_sent);
        }

        // Button Logout behaviour
        function onLogout() {
            // TODO cookies deleted locally, still should send some POST for the server to update
            deleteAllCookies();
            location.href="/";
        }

        // AJAX method to write chat answers on screen
        function write(name_user, text) {
            chat = $('#chat_field').html();
            num_rep ++;
            if (num_rep > 25) {
                $('#chat_field').text(name_user + " said: " + text);
                num_rep = 0;
            } else {
                $('#chat_field').html(chat + '<br/>' + name_user + " said: " + text);
            }
        }

        // Gets the cookie or creates a new one if it doesn't exist
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Deletes all the content of the cookie and sets expire-date already expired
        function deleteAllCookies() {
            var cookies = document.cookie.split(";");

            for (var i = 0; i < cookies.length; i++) {
    	        var cookie = cookies[i];
    	        var eqPos = cookie.indexOf("=");
    	        var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
    	        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
            }
        }

        // Loads part of the webpage - AJAX
        function loadXMLDoc(text_sent) {
            var csrftoken = getCookie('csrftoken');
//            var csrftoken = $.cookie('csrftoken');
            var xmlhttp;
            if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
                xmlhttp=new XMLHttpRequest();
            }
            else {// code for IE6, IE5
                xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange=function() {
                if (xmlhttp.readyState==4 && xmlhttp.status==200) {
                    document.getElementById("chat_field").innerHTML+=xmlhttp.responseText;
                }
            }
            xmlhttp.open("POST","/chat/",true);
            xmlhttp.setRequestHeader("X-CSRFToken",csrftoken);
//            xmlhttp.setRequestHeader("user",user);
//            xmlhttp.setRequestHeader("msg",text_sent);
//            xmlhttp.send("user="+user+"&msg="+text_sent);
            xmlhttp.send('{"user":"'+user+'","msg":"'+text_sent+'"}');
//            xmlhttp.ajaxSend() fixme
        }



    </script>
</body>
</html>