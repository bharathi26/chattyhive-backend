<!DOCTYPE html>
<html>
<head>
    <title>CHAT</title>
    <script src="http://js.pusher.com/2.1/pusher.min.js" type="text/javascript"></script>
    <script src="jquery-2.0.3.min.js" type="text/javascript"></script>
</head>
<body>
    Welcome, {{ user }}!
    <p id="chat_field"></p>
    <form id="send_msg" action="/chat/" method="post">{% csrf_token %}
{#        {{ form.as_p }}#}
        <input type="submit" value="Send">
        <input id="msg_text" type="text">
{#        <button type="button" onclick="onClick()">Send</button>#}
{#        <input type="submit" onclick="onClick()" value="Send">#}
    </form>
    <script type="text/javascript">

        var num_rep=0;
        var user="{{ user }}";
        var app_key="{{ app_key }}";
        var key="{{ key }}";
        var channel_name="{{ channel }}";
        var event_name="{{ event }}";
        var chat="{{ chat_field }}";

        // Connecting to pusher
        var pusher = new Pusher(key);
        var channel = pusher.subscribe(channel_name);

        // Listening to the channel
        channel.bind(event_name, function(data) {
            write(data.user,data.msg);
        });

        // Button Send behaviour
        // TODO not used now
        function onClick() {
            var text_sent = document.getElementById("msg_text").value;
            document.getElementById("msg_text").value="";
            write(user, text_sent);
{#            document.getElementById('send_msg').submit();#}
{#            alert("Submit realizado");#}
{#              send_post(text_sent);#}
            send_jquery(text_sent);
        }

        // AJAX method to write chat answers on screen
        function write(name_user, text) {
            chat = document.getElementById("chat_field").valueOf(); // TODO trying to store previous messages
//            alert(chat);
            num_rep ++;
            if (num_rep > 25) {
                document.getElementById("chat_field").innerHTML = name_user + " said: " + text + "<br/>";
                num_rep = 0;
            } else {
                document.getElementById("chat_field").innerHTML += name_user + " said: " + text + "<br/>";
            }
        }

        // TODO that's for creating our own form, not used yet
        function send_post(msg_text) {
            var form = document.createElement("FORM");
            form.method = 'POST';
            form.action = '/chat/';
            form.value = msg_text;
            alert(msg_text);
            form.submit();
        }

        function send_jquery(msg_text){
{#            var sortid = $('#sort').val().toLowerCase();#}
            alert("send_jquery")
            $.ajax({
                type:"POST",
                url: "/chat/",
                data: {msg: msg_text},
                success: function(newData){
                    document.getElementById("chat_field").html('---->ok');
                }
            });
            alert("jquery working");
        }

        $(document).ready(function() {
            $('send_msg').submit(function()
            {
                alert("submit_catched")
                $.ajax({
                    type: "POST",
                    url: "/chat/",
                    data: {msg: msg_text},
                    success: function(newData){
                        document.getElementById("chat_field").html('---->ok');
                    },
                    failure: function(errMsg) {
                        alert(errMsg);
                    },
                });
                return false;
            });
        });
    </script>
</body>
</html>