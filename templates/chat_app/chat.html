<!DOCTYPE html>
<html>
<head>
    <title>CHAT</title>
    <script src="http://js.pusher.com/2.1/pusher.min.js" type="text/javascript"></script>
</head>
<body>
    Welcome, {{ user }}!
    <p id="chat_field"></p>
    <input id="msg_text" type="text">
    <button type="button" onclick="onClick()">Send</button>
    <script type="text/javascript">

        var num_rep=0;
        var user="{{ user }}";
        var app_key="{{ app_key }}";
        var key="{{ key }}";
        var channel_name="{{ channel }}";
        var event_name="{{ event }}";

        var pusher = new Pusher(key);
        var channel = pusher.subscribe(channel_name);

        channel.bind(event_name, function(data) {
            write(data.user,data.msg);
        });

        function onClick() {
            var text_sended = document.getElementById("msg_text").value;
            document.getElementById("msg_text").value="";
            write(user, text_sended);
            send_post(text_sended);
        }

        function write(name_user, text) {
            num_rep ++;
            if (num_rep > 25) {
                document.getElementById("chat_field").innerHTML = name_user + " said: " + text + "<br/>";
                num_rep = 0;
            } else {
                document.getElementById("chat_field").innerHTML += name_user + " said: " + text + "<br/>";
            }
        }

        function send_post(msg_text) {
            var form = document.createElement("form");
            form.setAttribute("method","post");
            form.setAttribute("name","msg");
            form.setAttribute("action","/chat/");
            form.setAttribute("user",user);
            form.setAttribute("value",msg_text);
            form.appendChild(form);
            alert(msg_text);
            form.submit();
        }
    </script>
</body>
</html>